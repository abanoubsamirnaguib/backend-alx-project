# Fly.io Deployment Guide

This guide explains how to deploy the ALX Nexus E-commerce Backend to Fly.io.

## Prerequisites

1. **Install Fly CLI**: Visit [https://fly.io/docs/hands-on/install-flyctl/](https://fly.io/docs/hands-on/install-flyctl/)
2. **Create Fly.io account**: Sign up at [https://fly.io](https://fly.io)
3. **Authenticate**: Run `fly auth login`

## Deployment Options

### Option 1: Automated Deployment (Recommended)

**On Windows:**
```cmd
deploy.bat
```

**On Linux/Mac:**
```bash
chmod +x deploy.sh
./deploy.sh
```

### Option 2: Manual Deployment

1. **Create the app:**
   ```bash
   fly apps create alx-project-nexus-ecommerce
   ```

2. **Generate and set secrets:**
   ```bash
   # Generate Django secret key
   python generate_secret_key.py
   
   # Set environment variables
   fly secrets set SECRET_KEY="your-generated-secret-key"
   fly secrets set DEBUG=False
   fly secrets set ALLOWED_HOSTS="alx-project-nexus-ecommerce.fly.dev,.fly.dev"
   ```

3. **Create PostgreSQL database:**
   ```bash
   fly postgres create --name alx-project-nexus-ecommerce-db --region iad --initial-cluster-size 1
   fly postgres attach alx-project-nexus-ecommerce-db
   ```

4. **Create persistent volume for media files:**
   ```bash
   fly volumes create nexus_data --region iad --size 1
   ```

5. **Deploy:**
   ```bash
   fly deploy
   ```

## Configuration Files

- `fly.toml` - Main Fly.io configuration
- `Dockerfile` - Container configuration
- `.dockerignore` - Files to exclude from Docker build
- `deploy.sh` / `deploy.bat` - Automated deployment scripts

## Environment Variables

Required secrets (set via `fly secrets set`):

| Variable | Description | Example |
|----------|-------------|---------|
| `SECRET_KEY` | Django secret key | Generated by script |
| `DEBUG` | Debug mode (False for production) | `False` |
| `ALLOWED_HOSTS` | Allowed hostnames | `alx-nexus-ecommerce.fly.dev,.fly.dev` |
| `DATABASE_URL` | PostgreSQL connection (auto-set) | Auto-configured |

Optional secrets:

| Variable | Description | Example |
|----------|-------------|---------|
| `CORS_ALLOWED_ORIGINS` | Frontend domains | `https://your-frontend.com` |
| `CORS_ALLOW_ALL_ORIGINS` | Allow all CORS origins | `False` |

## Post-Deployment

1. **Check app status:**
   ```bash
   fly status
   ```

2. **View logs:**
   ```bash
   fly logs
   ```

3. **Open your app:**
   ```bash
   fly open
   ```

4. **Access admin panel:**
   - URL: `https://alx-project-nexus-ecommerce.fly.dev/admin/`
   - Create superuser: `fly ssh console` then `python manage.py createsuperuser`

## API Endpoints

Your deployed app will have these endpoints:

- Health check: `GET /api/health/`
- Categories: `GET /api/categories/`
- Food types: `GET /api/food-types/`
- Ingredients: `GET /api/ingredients/`
- Orders: `POST /api/orders/`
- Authentication:
  - Register: `POST /api/auth/register/`
  - Login: `POST /api/auth/login/`
  - Profile: `GET /api/auth/profile/`
  - Token refresh: `POST /api/auth/token/refresh/`

## Scaling and Management

- **Scale up:** `fly scale count 2`
- **Scale resources:** `fly scale vm shared-cpu-1x --memory 512`
- **Update secrets:** `fly secrets set KEY=VALUE`
- **SSH access:** `fly ssh console`

## Troubleshooting

1. **App won't start:**
   - Check logs: `fly logs`
   - Verify secrets: `fly secrets list`

2. **Database issues:**
   - Check connection: `fly postgres connect -a alx-project-nexus-ecommerce-db`
   - Run migrations: `fly ssh console` then `python manage.py migrate`

3. **Static files missing:**
   - Files are served by WhiteNoise
   - Collected during deployment via `collectstatic`

4. **CORS errors:**
   - Set `CORS_ALLOWED_ORIGINS` for your frontend domain
   - For development, use `CORS_ALLOW_ALL_ORIGINS=True`

5. **ALLOWED_HOSTS errors:**
   - The app is configured for both Fly.io and Railway deployments
   - Fly.io domains: `alx-project-nexus-ecommerce.fly.dev`, `.fly.dev`
   - Railway domains: `web-production-af360.up.railway.app`, `.up.railway.app`
   - Set custom domains via environment variables if needed

## Railway Deployment

This app is also configured for Railway deployment. The `ALLOWED_HOSTS` includes Railway domains automatically.

**Railway deployment URLs:**
- Main app: `https://web-production-af360.up.railway.app`
- Admin: `https://web-production-af360.up.railway.app/admin/`

**Railway environment variables to set:**
- `SECRET_KEY` - Django secret key
- `DEBUG` - Set to `False` for production
- `ALLOWED_HOSTS` - Custom domains if needed
- `DATABASE_URL` - Auto-configured by Railway PostgreSQL

## Support

- Fly.io docs: [https://fly.io/docs/](https://fly.io/docs/)
- Django deployment: [https://docs.djangoproject.com/en/5.0/howto/deployment/](https://docs.djangoproject.com/en/5.0/howto/deployment/)